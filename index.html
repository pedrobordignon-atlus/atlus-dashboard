<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Atlus Dashboards</title>

  <link rel="icon" type="image/png" href="favicon.png">
  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --navy:#0a1b2b; --navy-2:#0f2436; --panel:#0e2234; --border:#15354f;
      --text:#e9f1fb; --text-dim:#a7bfd9; --blue:#0077c8; --gold:#ffb81c; --green:#19c37d;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    /* === C1-B: Atlus background (modern + visible tech grid) === */
body{
  margin:0;
  /* Base + Atlus hero image + soft color glows */
  background:
    radial-gradient(900px 600px at 12% 10%, rgba(0,119,200,.12), transparent 70%),
    radial-gradient(900px 600px at 88% 12%, rgba(255,184,28,.14), transparent 70%),
    url('./Atlus_logo_files/atlus-bg.png') no-repeat center 200px,
    var(--navy);
  background-size: auto, auto, 780px auto, auto;
  background-attachment: fixed, fixed, fixed, fixed;
  color:var(--text);
  font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  position: relative;
  overflow-x: hidden;
}

/* Watermark (favicon) ‚Äî stays subtle behind content */
body::before{
  content:"";
  position:fixed;
  top:50%;
  left:50%;
  width:680px;
  height:680px;
  transform:translate(-50%,-50%);
  background:url('./Atlus_logo_files/favicon.png') no-repeat center center;
  background-size:contain;
  opacity:0.08;           /* a bit stronger than before for visibility */
  pointer-events:none;
  z-index:0;              /* below header/main (which are z-index:1) */
}

/* Tech grid overlay (visible C1-B) */
body::after{
  content:"";
  position:fixed;
  inset:0;
  /* two perpendicular line layers to form the grid */
  background-image:
    linear-gradient(rgba(255,184,28,0.10) 1px, transparent 1px),         /* horizontal lines (gold) */
    linear-gradient(90deg, rgba(0,119,200,0.12) 1px, transparent 1px);   /* vertical lines (blue) */
  background-size: 46px 46px, 46px 46px;  /* grid cell size */
  background-position: 0 0, 0 0;
  opacity:0.35;            /* C1-B: more visible */
  pointer-events:none;
  z-index:0;               /* stays behind content */
}

/* Ensure content sits above overlays */
header, main { position: relative; z-index: 1; }
    header, main { position: relative; z-index: 1; }

    /* Header */
    header{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 18px; background:rgba(10,27,43,.85); backdrop-filter: blur(6px);
      border-bottom:1px solid var(--border);
    }
    .brand{display:flex;align-items:center;gap:12px;font-weight:700}
    .logo{width:40px;height:40px;display:flex;align-items:center;justify-content:center}
    .logo img{height:100%;width:auto;object-fit:contain}

    /* UI */
    .btn{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0a2236;color:var(--text);cursor:pointer}
    .btn.primary{background:#0077c8;border-color:transparent;color:#fff;font-weight:600}
    .btn.link{background:transparent;border:1px solid var(--border);color:var(--text-dim)}
    .muted{color:var(--text-dim)}
    .input, select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#08192a;color:var(--text)}

    .container{max-width:1220px;margin:0 auto;padding:24px;display:grid;gap:22px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px 18px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}

    .hero{padding:22px;background:rgba(10,27,43,.55);border:1px solid var(--border);border-radius:16px;text-align:center;display:flex;flex-direction:column;align-items:center}
    .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:22px}
    .card{background:#081b2b;border:1px solid var(--border);border-radius:16px;padding:18px;display:grid;gap:10px}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);color:var(--text-dim)}
    @media (max-width:1100px){.cards{grid-template-columns:1fr}}

    .kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:14px}
    @media(max-width:1100px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    .kpi{background:#081b2b;border:1px solid var(--border);border-radius:14px;padding:12px}
    .kpi .label{font-size:12px;color:var(--text-dim)}
    .kpi .value{font-size:22px;font-weight:700;display:flex;align-items:center;gap:8px}
    .kpi .dot{width:8px;height:8px;border-radius:999px;display:inline-block;opacity:.6}
    .dot.blue{background:#0077c8} .dot.gold{background:#ffb81c} .dot.green{background:#19c37d}

    .filters{display:grid;grid-template-columns:1.2fr 1.2fr 1.2fr auto;gap:12px}
    @media(max-width:1100px){ .filters{grid-template-columns:1fr} }

    .grid-2{display:grid;grid-template-columns:2fr 1.4fr;gap:18px}
    @media(max-width:1100px){.grid-2{grid-template-columns:1fr}}

    .noteTitle{font-weight:700;margin-bottom:6px}
    .note{border-left:3px solid var(--blue);padding-left:12px}
    .stack{display:grid;gap:12px}
    .backRow{display:flex;align-items:center;gap:8px}
    /* hide the bottom "Reload" button (legacy) */
    #reloadBtn { display:none !important; }

    /* ==== Admin visibility helpers ==== */
.admin-only{ display:none; }              /* escondido por padr√£o */
.if-admin{ display:none; }                /* elementos s√≥ p/ admin */
.if-guest{ display:inline-flex; }         /* elementos s√≥ p/ visitante */
body.admin .admin-only{ display:block; }
body.admin .if-admin{ display:inline-flex; }
body.admin .if-guest{ display:none; }

/* Mini-modal simples de login (n√£o muda layout) */
#adminLoginBox{
  position: fixed; inset: 0; display: none; place-items: center;
  background: rgba(0,0,0,.45); z-index: 1000;
}
#adminLoginCard{
  width: 320px; background: var(--panel); border:1px solid var(--border);
  border-radius: 16px; padding: 16px; display: grid; gap: 10px;
}
  </style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">
      <img src="Atlus_logo_files/favicon.png" alt="Atlus" width="40" height="40" onerror="this.src='favicon.png';">
    </div>
    <div class="title" id="headerTitle">Atlus Dashboards</div>
  </div>
  <div style="display:flex; align-items:center; gap:8px">
  <button class="btn link if-guest" id="openAdminLogin">Admin</button>
  <button class="btn link if-admin" id="logoutBtn">Logout</button>
  <div class="muted" id="lastUpdated">Last updated: ‚Äî</div>
</div>
</header>
<!-- Admin login lightbox -->
<div id="adminLoginBox">
  <div id="adminLoginCard">
    <div style="font-weight:700">Admin login</div>
    <input id="adminPassword" class="input" type="password" placeholder="Password" />
    <div style="display:flex; gap:8px; justify-content:flex-end">
      <button class="btn link" id="cancelAdminLogin">Cancel</button>
      <button class="btn primary" id="confirmAdminLogin">Enter</button>
    </div>
    <div class="muted" id="adminLoginMsg"></div>
  </div>
</div>
<main class="container">

  <!-- HOME -->
  <section id="view-home" class="stack" style="display:none">
    <div class="hero">
      <h1 style="margin:0">Welcome to <span style="color:#dbeafe">Atlus Dashboards</span></h1>
      <div class="muted">Choose a dashboard below. You can come back here anytime.</div>
      <!-- NEW: add quick buttons for both dashboards -->
      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
        <button class="btn primary" onclick="openView('atlus')">Open Atlus Performance Dashboard</button>
        <button class="btn" onclick="openView('bonus')">Open Bonus & Tech Dashboard</button>
      </div>
    </div>

    <div class="cards">
      <div class="card">
        <div class="pill">Featured</div>
        <h3 style="margin:2px 0 0">Atlus Performance Dashboard</h3>
        <div class="muted">Leads, Spend, ROI, Profit + performance KPIs for LSA & Thumbtack.</div>
        <div><button class="btn" onclick="openView('atlus')">Open</button></div>
      </div>

      <!-- NEW: Bonus & Tech card -->
      <div class="card">
        <div class="pill">New</div>
        <h3 style="margin:2px 0 0">Bonus & Tech Dashboard</h3>
        <div class="muted">Bonus by tech, status and notes for the current pay period.</div>
        <div><button class="btn" onclick="openView('bonus')">Open</button></div>
      </div>

      <div class="card" style="align-content:start">
        <div class="pill">Future dashboard</div>
        <h3 style="margin:2px 0 0">Coming soon</h3>
        <div><button class="btn link" disabled>Soon</button></div>
      </div>
    </div>
  </section>

  <!-- ATLUS -->
  <section id="view-atlus" class="stack" style="display:none">

    <div class="backRow">
      <button class="btn link" onclick="openView('home')">‚Üê Back to Home</button>
    </div>

    <div class="panel admin-only">
      <div class="noteTitle">üëã Hello, Atlus coworker, glad to see you here!</div>
      <div class="note">
        This dashboard shows leads from the platforms we currently pay for:
        <b>LSAs + Thumbtack</b>.<br>
        <b>Important:</b> <i>Thumbtack spend is paid at the company level (Atlus overall)</i>, so its 
        <b>locations</b> will appear as <b>‚ÄúAll locations‚Äù</b> by design.
      </div>

      <div class="note" style="margin-top:8px">
        <b>Tip:</b> If you don‚Äôt see the data yet, click 
        <a href="#" onclick="document.getElementById('reloadBtn').click(); return false;">
          <u>Reload</u>
        </a>
        to load it.
      </div>
    </div>

    <!-- Single RELOAD button (moved up) -->
    <div class="panel" style="display:flex;justify-content:flex-end;gap:10px;align-items:center">
      <button class="btn primary" id="reloadBtn">Reload</button>
    </div>

    <!-- Filters -->
    <div class="panel filters">
      <div>
        <label class="muted">Month / Year</label>
        <select id="monthFilter"></select>
      </div>
      <div>
        <label class="muted">Location</label>
        <select id="locationFilter"></select>
      </div>
      <div>
        <label class="muted">Platform</label>
        <select id="platformFilter"></select>
      </div>
      <div style="display:grid;align-content:end">
        <button class="btn" id="clearFilters">Clear</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi"><div class="label">Leads</div><div class="value"><span class="dot blue"></span><span id="kpiLeads">‚Äî</span></div></div>
      <div class="kpi"><div class="label">Spend</div><div class="value"><span class="dot blue"></span><span id="kpiSpend">‚Äî</span></div></div>
      <div class="kpi"><div class="label">Closed Jobs</div><div class="value"><span class="dot gold"></span><span id="kpiJobs">‚Äî</span></div></div>
      <div class="kpi"><div class="label">Contract Total</div><div class="value"><span class="dot gold"></span><span id="kpiContract">‚Äî</span></div></div>
      <div class="kpi"><div class="label">Profit</div><div class="value"><span class="dot green"></span><span id="kpiProfit">‚Äî</span></div></div>
      <div class="kpi"><div class="label">ROI</div><div class="value"><span class="dot green"></span><span id="kpiROI">‚Äî</span></div></div>
      <div class="kpi"><div class="label">Approx. Daily Spend</div><div class="value"><span class="dot blue"></span><span id="kpiDaily">‚Äî</span></div></div>
      <div class="kpi"><div class="label">Close Rate</div><div class="value"><span class="dot gold"></span><span id="kpiClose">‚Äî</span></div></div>
      <div class="kpi"><div class="label">% Good Leads</div><div class="value"><span class="dot green"></span><span id="kpiGood">‚Äî</span></div></div>
    </div>

    <!-- Charts -->
    <div class="grid-2">
      <div class="panel">
        <div style="margin-bottom:8px;font-weight:700">Leads per Platform</div>
        <canvas id="chartLeads"></canvas>
      </div>
      <div class="panel">
        <div style="margin-bottom:8px;font-weight:700">ROI per Location</div>
        <canvas id="chartROI"></canvas>
      </div>
    </div>

    <div class="panel">
      <div style="margin-bottom:8px;font-weight:700">Profit per Location</div>
      <canvas id="chartProfit"></canvas>
    </div>

    <!-- Data source (bottom) -->
    <div class="panel">
      <div class="row">
        <div><label class="muted">Live CSV link</label><input id="csvUrl" class="input" placeholder="https://docs.google.com/.../output=csv"></div>
        <div style="max-width:300px"><label class="muted">or CSV upload</label><input id="csvFile" type="file" class="input" accept=".csv"></div>
        <div style="max-width:160px"><label class="muted">&nbsp;</label><button id="reloadBtn" class="btn primary">Reload</button></div>
        <div style="max-width:220px"><label class="muted">&nbsp;</label><label class="muted" style="display:flex;gap:8px;align-items:center"><input id="autoRefresh" type="checkbox" checked> Live (auto-refresh 5 min)</label></div>
      </div>
      <div id="statusChips" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap"></div>
    </div>
  </section>

  <!-- ========== BONUS & TECH DASHBOARD ========== -->
  <section id="view-bonus" class="stack" style="display:none">
    <div class="backRow">
      <button class="btn link" onclick="openView('home')">‚Üê Back to Home</button>
    </div>

    <div class="panel admin-only">
      <div class="noteTitle">üß∞ Bonus & Tech Dashboard (current pay period)</div>
      <div class="note">
        This panel reads <b>only the active sheet</b> of the guide (current pay period). Paste the
        <b>CSV link of the guide</b> below and click <b>Reload</b>.
      </div>
    </div>

    <!-- Filters -->
    <div class="panel filters">
      <div>
        <label class="muted">Tech / Owner</label>
        <select id="btOwner"></select>
      </div>
      <div>
        <label class="muted">Status</label>
        <select id="btStatus">
          <option value="">All status</option>
          <option value="Completed">Completed</option>
          <option value="Pending">Pending</option>
        </select>
      </div>
      <div>
        <label class="muted">Job (contains)</label>
        <input id="btJobSearch" class="input" placeholder="e.g., Trelona, Bed Bug...">
      </div>
      <div style="display:grid;align-content:end;gap:8px">
        <button class="btn" id="btClear">Clear</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi"><div class="label">Jobs</div><div class="value"><span class="dot blue"></span><span id="btJobs">‚Äî</span></div></div>
      <div class="kpi"><div class="label">Completed</div><div class="value"><span class="dot green"></span><span id="btCompleted">‚Äî</span></div></div>
      <div class="kpi"><div class="label">Pending</div><div class="value"><span class="dot gold"></span><span id="btPending">‚Äî</span></div></div>
      <div class="kpi"><div class="label">Contract Total</div><div class="value"><span class="dot blue"></span><span id="btContractTotal">‚Äî</span></div></div>
      <div class="kpi"><div class="label">Bonus Total</div><div class="value"><span class="dot green"></span><span id="btBonusTotal">‚Äî</span></div></div>
      <div class="kpi"><div class="label">Avg Bonus / Job</div><div class="value"><span class="dot gold"></span><span id="btAvgBonus">‚Äî</span></div></div>
    </div>

    <!-- Data source -->
    <div class="panel">
      <div class="row">
        <div><label class="muted">Guide CSV link (active sheet)</label><input id="btCsvUrl" class="input" placeholder="https://docs.google.com/.../output=csv"></div>
        <div style="max-width:160px"><label class="muted">&nbsp;</label><button id="btReload" class="btn primary">Reload</button></div>
      </div>
      <div id="btStatusChips" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap"></div>
    </div>

    <!-- Table (simple list) -->
    <div class="panel">
      <div style="margin-bottom:8px;font-weight:700">Jobs</div>
      <div id="btTable" style="display:grid;gap:8px"></div>
    </div>
  </section>

</main>

<script>
  /* ==== Admin login state ==== */
const ADMIN_PASS = "32832126";
const ADMIN_KEY  = "atl_admin"; // localStorage flag

function isAdmin(){ return localStorage.getItem(ADMIN_KEY) === "1"; }
function setAdmin(on){
  if(on){ localStorage.setItem(ADMIN_KEY, "1"); document.body.classList.add("admin"); }
  else  { localStorage.removeItem(ADMIN_KEY); document.body.classList.remove("admin"); }
}

/* Init admin state on load */
(function(){
  if(isAdmin()){ document.body.classList.add("admin"); }
})();
/* ===== View router ===== */
function openView(which){
  // Close any open native dropdowns by blurring the focused element
  if (document.activeElement && typeof document.activeElement.blur === 'function') {
    document.activeElement.blur();
  }
  // Also proactively blur all selects (prevents ‚Äúghost‚Äù options overlay)
  document.querySelectorAll('select').forEach(el => el.blur());

  // Switch views
  document.getElementById('view-home').style.display  = (which === 'home')  ? 'block' : 'none';
  document.getElementById('view-atlus').style.display = (which === 'atlus') ? 'block' : 'none';
  const vb = document.getElementById('view-bonus'); if(vb){ vb.style.display = (which === 'bonus') ? 'block' : 'none'; }

  document.getElementById('headerTitle').textContent =
    (which === 'home')  ? 'Atlus Dashboards' :
    (which === 'atlus') ? 'Atlus Performance Dashboard' :
    'Bonus & Tech Dashboard';

  // Normalize URL and scroll to top to avoid leftover overlays
  history.replaceState(null, '', location.pathname + '?view=' + which);
  window.scrollTo({ top: 0, left: 0, behavior: 'auto' });
}
(function initViewFromURL(){
  const p = new URLSearchParams(location.search);
  const v = p.get('view');
  openView(v === 'atlus' ? 'atlus' : (v === 'bonus' ? 'bonus' : 'home'));
})();

/* ===== Helpers ===== */
function $(id){return document.getElementById(id);}
function setUpdated(){ $('lastUpdated').textContent = 'Last updated: ' + new Date().toLocaleString('en-US',{hour:'numeric',minute:'2-digit'}) }
function chip(t){ const s=document.createElement('span'); s.style.border='1px solid var(--border)'; s.style.background='#09192a'; s.style.color='#a7bfd9'; s.style.padding='6px 10px'; s.style.borderRadius='999px'; s.style.fontSize='12px'; s.textContent=t; return s; }
function chips(msgs){const c=$('statusChips'); c.innerHTML=''; msgs.forEach(m=>c.appendChild(chip(m)))}
function fmtUSD(v){return isFinite(v)?v.toLocaleString('en-US',{style:'currency',currency:'USD'}):'‚Äî'}
function fmtInt(v){return isFinite(v)?v.toLocaleString('en-US'):'‚Äî'}
function norm(s){return String(s||'').toLowerCase().trim()}

/* ===== Number / sanitize ===== */
function toNumber(x){
  if (x==null || x==='') return 0;
  if (typeof x==='number' && isFinite(x)) return x;
  let s = String(x).trim().replace(/[^0-9.\-]/g,'');
  if ((s.match(/\./g)||[]).length>1) s = s.replace(/\.(?=.*\.)/g,'');
  const n = parseFloat(s);
  return isFinite(n)?n:0;
}

/* ===== CSV parsing ===== */
function detectColumns(headers){
  const h=headers.map(x=>String(x||'').toLowerCase());
  const find = keys => { for(let i=0;i<h.length;i++){ for(let j=0;j<keys.length;j++){ if(h[i].includes(keys[j])) return i; } } return -1; };
  return { platform:find(['platform','source']), location:find(['location','market']),
           metric:find(['metric','indicator']), monthyear:find(['monthyear','period','date']),
           month:find(['month']), value:find(['value','amount','qty','number']) };
}
function parseCSVText(text){
  const res=Papa.parse(text,{skipEmptyLines:true});
  const rows=res.data||[]; if(rows.length<2) return {headers:[],rows:[]};
  const headers=rows[0].map(x=>String(x||'')); const col=detectColumns(headers);
  const out=[];
  for(let i=1;i<rows.length;i++){
    const r=rows[i]; if(!r||!r.length)continue;
    const get=idx=> (idx>=0&&idx<r.length)?r[idx]:''; 
    out.push({ Platform:String(get(col.platform)).trim(),
               Location:String(get(col.location)).trim(),
               Metric:String(get(col.metric)).trim(),
               Month:String(col.monthyear>=0?get(col.monthyear):(col.month>=0?get(col.month):'')).trim(),
               ValueRaw:get(col.value) });
  }
  return {headers,rows:out};
}

/* ===== reshape long->wide ===== */
function pivotLong(rows){
  const map={}, out=[];
  rows.forEach(r=>{
    if(!r || !r.Month || !r.Platform) return;
    if(r.Month==='#DIV/0!'||r.Platform==='#DIV/0!') return;

    const plat = String(r.Platform||'').trim();
    const platN = plat.toLowerCase();
    const locRaw = String(r.Location||'').trim();
    const locN = locRaw.toLowerCase();

    const loc = locRaw || 'All locations';
    if ((locN==='all locations'||locN==='all location') && platN!=='thumbtack') return;

    const k = [r.Month, loc, plat].join('||');
    (map[k]||(map[k]=[])).push({ Month:r.Month, Location:loc, Platform:plat, Metric:r.Metric, ValueRaw:r.ValueRaw });
  });

  Object.keys(map).forEach(k=>{
    const [Month,Location,Platform]=k.split('||');
    const rec = {Month, Location, Platform, Leads:0, Spend:0, JobsClosed:0, ContractTotal:0, Profit:0, ROI:null, CPJ:0, GoodPct:null};
    map[k].forEach(row=>{
      const m = String(row.Metric||'').toLowerCase();
      const raw = (row.ValueRaw==null?'':String(row.ValueRaw));
      let s = raw.trim().replace(/[^0-9.\-]/g,''); if((s.match(/\./g)||[]).length>1) s=s.replace(/\.(?=.*\.)/g,'');
      let v = parseFloat(s); v = isFinite(v)?v:0;

      if ((m.includes('spend') && !m.includes('daily')) || m.includes('monthly spend')) rec.Spend += v;
      else if (m.includes('number of leads')) rec.Leads += v;
      else if (m.includes('closed job')) rec.JobsClosed += v;
      else if (m.includes('contract total')) rec.ContractTotal += v;
      else if (m==='roi' || m==='roi (%)'){
        let t=v; if(raw.includes('%')) t=(+raw.replace(/[^0-9.\-]/g,''))/100;
        if(t>1.5)t/=100; rec.ROI=t;
      }
      else if (m.includes('% good')){
        let t=v; if(raw.includes('%')) t=(+raw.replace(/[^0-9.\-]/g,''))/100;
        if(t>1.5)t/=100; rec.GoodPct=t;
      }
      else if (m.includes('profit')) rec.Profit += v;
    });

    if(!rec.Profit) rec.Profit = rec.ContractTotal - rec.Spend;
    if(rec.ROI==null) rec.ROI = rec.Spend>0 ? rec.Profit/rec.Spend : 0;
    rec.CPJ = rec.JobsClosed>0 ? rec.Spend/rec.JobsClosed : 0;

    rec.Leads = Math.round(rec.Leads);
    rec.JobsClosed = Math.round(rec.JobsClosed);
    rec.Spend = +rec.Spend.toFixed(2);
    rec.ContractTotal = +rec.ContractTotal.toFixed(2);
    rec.Profit = +rec.Profit.toFixed(2);

    out.push(rec);
  });

  return out;
}

function uniqSortedClean(arr, excludeAllLocations){
  const seen={}, out=[];
  arr.forEach(s=>{
    const t=String(s||'').trim(); const n=t.toLowerCase();
    if(excludeAllLocations && (n==='all locations'||n==='all location')) return;
    if(!seen[n]){ seen[n]=true; out.push(t); }
  });
  return out.sort();
}
function sum(arr,k){ let t=0; for(let i=0;i<arr.length;i++){ t += (+arr[i][k]||0) } return t }

/* ===== State ===== */
let original=[], filtered=[];
let leadsChart=null, roiChart=null, profitChart=null;

/* ===== Filters ===== */
function daysInMonth(name){
  const d = new Date(name+' 01'); if(isNaN(d)) return 30;
  const y=d.getFullYear(), m=d.getMonth(); return new Date(y, m+1, 0).getDate();
}
function fillFilters(data){
  const months = [...new Set(data.map(r=>r.Month))].sort((a,b)=> new Date(a) - new Date(b));
  const locs  = uniqSortedClean(data.map(r=>r.Location), true);
  const plats = uniqSortedClean(data.map(r=>r.Platform), false);

  // fix common typos in option labels (e.g., "Pendig" -> "Pending")
  const fixLabel = (t) => {
    const l = String(t||'').trim();
    return (l.toLowerCase() === 'pendig') ? 'Pending' : l;
    };

  const fill = (id, arr, label)=>{
    const s=$(id); s.innerHTML='';
    const opt=document.createElement('option'); opt.value=''; opt.textContent='All '+label; s.appendChild(opt);
    arr.forEach(v=>{
      const e=document.createElement('option');
      e.value=v;
      e.textContent=fixLabel(v);
      s.appendChild(e);
    });
  };
  fill('monthFilter', months, 'months');
  fill('locationFilter', locs,  'locations');
  fill('platformFilter', plats, 'platforms');
}
function applyFilters(){
  const m=$('monthFilter').value, l=$('locationFilter').value, p=$('platformFilter').value;
  filtered = original.filter(r => (m?r.Month===m:true) && (l?r.Location===l:true) && (p?r.Platform===p:true));
  updateKPIs(); updateCharts();
}

/* ===== KPIs ===== */
function updateKPIs(){
  const leads = sum(filtered,'Leads'),
        spend = sum(filtered,'Spend'),
        jobs  = sum(filtered,'JobsClosed'),
        contract = sum(filtered,'ContractTotal'),
        profit   = sum(filtered,'Profit'),
        roi = spend>0 ? profit/spend : 0;

  let days = 0;
  const monthSel = $('monthFilter').value;
  if(monthSel){ days = daysInMonth(monthSel); }
  else{
    const months = [...new Set(filtered.map(r=>r.Month))];
    if(months.length>0) days = months.map(daysInMonth).reduce((a,b)=>a+b,0);
    if(days===0) days = 30;
  }
  const daily = spend>0 ? spend/Math.max(1, days) : 0;

  const closeRate = leads>0 ? (jobs/leads) : 0;

  let wNum=0, wDen=0;
  filtered.forEach(r=>{
    if(r.GoodPct!=null && r.Leads>0){ wNum += r.GoodPct * r.Leads; wDen += r.Leads; }
  });
  const goodPct = (wDen>0) ? (wNum/wDen) : null;

  $('kpiLeads').textContent     = fmtInt(Math.round(leads));
  $('kpiSpend').textContent     = fmtUSD(spend);
  $('kpiJobs').textContent      = fmtInt(Math.round(jobs));
  $('kpiContract').textContent  = fmtUSD(contract);
  $('kpiProfit').textContent    = fmtUSD(profit);
  $('kpiROI').textContent       = isFinite(roi)?((roi*100).toFixed(1)+'%'):'‚Äî';
  $('kpiDaily').textContent     = fmtUSD(daily);
  $('kpiClose').textContent     = (closeRate*100).toFixed(1)+'%';
  $('kpiGood').textContent      = (goodPct==null)?'‚Äî':((goodPct*100).toFixed(1)+'%');
}

/* ===== Charts ===== */
function updateCharts(){
  const mp={}; filtered.forEach(r=>{ mp[r.Platform]=(mp[r.Platform]||0)+(r.Leads||0) });
  const l1=Object.keys(mp), d1=l1.map(k=>mp[k]);
  if(leadsChart) leadsChart.destroy();
  leadsChart=new Chart($('chartLeads').getContext('2d'),{
    type:'bar',
    data:{labels:l1,datasets:[{label:'Leads',data:d1,backgroundColor:'rgba(0,119,200,.6)',borderColor:'#0077c8',borderWidth:1}]},
    options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });

  const byLoc={};
  filtered.forEach(r=>{
    const n = norm(r.Location);
    if(n==='all locations'||n==='all location') return;
    (byLoc[r.Location]||(byLoc[r.Location]={s:0,p:0})).s += r.Spend||0;
    (byLoc[r.Location]).p += r.Profit||0;
  });
  const l2=Object.keys(byLoc), d2=l2.map(loc=>{
    const o=byLoc[loc]; return o.s>0?+((o.p/o.s)*100).toFixed(1):0;
  });
  if(roiChart) roiChart.destroy();
  roiChart=new Chart($('chartROI').getContext('2d'),{
    type:'bar',
    data:{labels:l2,datasets:[{label:'ROI (%)',data:d2,backgroundColor:'rgba(25,195,125,.6)',borderColor:'#19c37d',borderWidth:1}]},
    options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true,ticks:{callback:v=>Number(v).toFixed(1)+'%'}}}}
  });

  const agg={}, pairs=[];
  filtered.forEach(r=>{
    const n=norm(r.Location); if(n==='all locations'||n==='all location') return;
    agg[r.Location]=(agg[r.Location]||0)+(r.Profit||0);
  });
  Object.keys(agg).forEach(k=>pairs.push({l:k,v:agg[k]}));
  const pPairs = pairs.filter(p=>p.v!==0).sort((a,b)=>b.v-a.v);
  const pLabels = pPairs.map(p=>p.l), pData=pPairs.map(p=>+p.v.toFixed(2));
  if(profitChart) profitChart.destroy();
  profitChart=new Chart($('chartProfit').getContext('2d'),{
    type:'bar',
    data:{labels:pLabels,datasets:[{label:'Profit ($)',data:pData,borderColor:'#ffb81c',backgroundColor:'rgba(255,184,28,.30)'}]},
    options:{responsive:true,plugins:{legend:{display:false}, tooltip:{callbacks:{label:ctx=>fmtUSD(ctx.parsed.y)}}},scales:{y:{beginAtZero:true,ticks:{callback:v=>fmtUSD(v)}}}}
  });
}

/* ===== Networking ===== */
function normalizeUrl(u){
  if(!u)return'';
  if(/tqx=out:csv/.test(u))return u;
  if(/\/pub\?/.test(u)&&/output=csv/.test(u))return u;
  const m=u.match(/spreadsheets\/d\/([^\/]+).*?[#\?].*?gid=(\d+)/);
  if(m)return 'https://docs.google.com/spreadsheets/d/'+m[1]+'/gviz/tq?tqx=out:csv&gid='+m[2];
  return u;
}
function withBust(url){ const s=url.includes('?')?'&':'?'; return url+s+'t='+(Date.now()) }
function fetchCsvText(url){
  url = withBust(url);
  return fetch(url,{mode:'cors'}).then(r=>{
    if(r.ok) return r.text();
    throw new Error('HTTP '+r.status);
  }).catch(()=>{
    const prox=(url.indexOf('https://')===0?'https://r.jina.ai/http://':'https://r.jina.ai/https://')+url.replace(/^https?:\/\//,'');
    return fetch(prox).then(r2=>{
      if(r2.ok) return r2.text();
      return fetch('https://cors.isomorphic-git.org/'+url).then(r3=>{
        if(r3.ok) return r3.text();
        throw new Error('All proxies failed');
      });
    });
  });
}

/* ===== Load & wire ===== */
function loadFromUrl(url){
  const normUrl=normalizeUrl(url.trim());
  if(!normUrl){ chips(['Paste a valid CSV link']); return; }
  chips(['Loading‚Ä¶']);
  fetchCsvText(normUrl).then(text=>{
    const parsed=parseCSVText(text);
    if(!parsed.rows||parsed.rows.length===0){ chips(['Empty CSV or headers not recognized']); return; }
    original=pivotLong(parsed.rows);
    fillFilters(original);
    $('monthFilter').value=''; $('locationFilter').value=''; $('platformFilter').value='';
    filtered=original.slice(0);
    applyFilters();
    chips(['CSV loaded: '+parsed.rows.length+' rows']);
    setUpdated();
  }).catch(err=>{
    chips(['Failed to load CSV: '+err.message]); console.error(err);
  });
}
function loadFromFile(file){
  chips(['Reading local CSV‚Ä¶']);
  Papa.parse(file,{complete:function(res){
    try{
      const csvText=Papa.unparse(res.data);
      const parsed=parseCSVText(csvText);
      if(!parsed.rows||parsed.rows.length===0){chips(['Local CSV empty']); return;}
      original=pivotLong(parsed.rows);
      fillFilters(original);
      $('monthFilter').value=''; $('locationFilter').value=''; $('platformFilter').value='';
      filtered=original.slice(0);
      applyFilters();
      chips(['Local CSV loaded']); setUpdated();
    }catch(e){ chips(['Local parse error: '+e.message]); }
  }});
}

/* Events */
$('reloadBtn').addEventListener('click',()=>loadFromUrl($('csvUrl').value));
$('csvFile').addEventListener('change',e=>{ const f=e.target.files[0]; if(f)loadFromFile(f); });
$('autoRefresh').addEventListener('change',e=>{
  if(e.target.checked){
    if(!window.__auto){ window.__auto=setInterval(()=> loadFromUrl($('csvUrl').value), 5*60*1000); }
  }else{
    if(window.__auto){ clearInterval(window.__auto); window.__auto=null; }
  }
});
$('clearFilters').addEventListener('click',()=>{ $('monthFilter').value=''; $('locationFilter').value=''; $('platformFilter').value=''; applyFilters(); });
['monthFilter','locationFilter','platformFilter'].forEach(id=> $(id).addEventListener('change',applyFilters));

/* ====== Bonus & Tech Dashboard (NEW) ====== */
function $bt(id){ return document.getElementById(id); }
function btChip(t){ const s=document.createElement('span'); s.style.border='1px solid var(--border)'; s.style.background='#09192a'; s.style.color='#a7bfd9'; s.style.padding='6px 10px'; s.style.borderRadius='999px'; s.style.fontSize='12px'; s.textContent=t; return s; }
function btChips(msgs){ const c=$bt('btStatusChips'); c.innerHTML=''; msgs.forEach(m=>c.appendChild(btChip(m))); }

function toNumUSD(x){
  if (x==null || x==='') return 0;
  let s = String(x).replace(/[^0-9.\-]/g,'').trim();
  if ((s.match(/\./g)||[]).length>1) s = s.replace(/\.(?=.*\.)/g,'');
  const n = parseFloat(s);
  return isFinite(n)?n:0;
}

function btDetectColumns(headers){
  const h=headers.map(x=>String(x||'').toLowerCase());
  const find = keys => { for(let i=0;i<h.length;i++){ for(let j=0;j<keys.length;j++){ if(h[i].includes(keys[j])) return i; } } return -1; };
  return { name:find(['name']), owner:find(['owner','tech']), status:find(['status']), job:find(['job']),
           contract:find(['contract']), bonus:find(['bonus']), notes:find(['note']) };
}

let BT_ALL = [], BT_VIEW = [];

function btParseCSV(text){
  const res = Papa.parse(text, { skipEmptyLines:true });
  const rows = res.data || [];
  if(rows.length < 2) return { rows:[] };

  const headers = rows[0].map(c=>String(c||''));
  const col = btDetectColumns(headers);

  const out=[];
  for(let i=1;i<rows.length;i++){
    const r = rows[i] || [];
    const get = idx => (idx>=0 && idx<r.length) ? r[idx] : '';
    const statusRaw = String(get(col.status)).trim();
    const status = /^pend/i.test(statusRaw) ? 'Pending' : (statusRaw || '');
    out.push({
      Name: String(get(col.name)).trim(),
      Owner: String(get(col.owner)).trim(),
      Status: status,
      Job: String(get(col.job)).trim(),
      Contract: toNumUSD(get(col.contract)),
      Bonus: toNumUSD(get(col.bonus)),
      Notes: String(get(col.notes)).trim()
    });
  }
  return { rows: out };
}

function btFillFilters(data){
  const owners = [...new Set(data.map(r=>r.Owner).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  const s=$bt('btOwner'); s.innerHTML='';
  const o=document.createElement('option'); o.value=''; o.textContent='All owners'; s.appendChild(o);
  owners.forEach(v=>{ const e=document.createElement('option'); e.value=v; e.textContent=v; s.appendChild(e); });
}

function btApply(){
  const owner = $bt('btOwner').value;
  const status = $bt('btStatus').value;
  const jobSub = $bt('btJobSearch').value.trim().toLowerCase();

  BT_VIEW = BT_ALL.filter(r=>{
    if(owner && r.Owner!==owner) return false;
    if(status && r.Status!==status) return false;
    if(jobSub && !String(r.Job||'').toLowerCase().includes(jobSub)) return false;
    return true;
  });

  const jobs = BT_VIEW.length;
  const completed = BT_VIEW.filter(r=>r.Status==='Completed').length;
  const pending = BT_VIEW.filter(r=>r.Status==='Pending').length;
  const contractTotal = BT_VIEW.reduce((a,b)=>a+(b.Contract||0),0);
  const bonusTotal = BT_VIEW.reduce((a,b)=>a+(b.Bonus||0),0);
  const avgBonus = jobs>0 ? (bonusTotal/jobs) : 0;

  $bt('btJobs').textContent = fmtInt(jobs);
  $bt('btCompleted').textContent = fmtInt(completed);
  $bt('btPending').textContent = fmtInt(pending);
  $bt('btContractTotal').textContent = fmtUSD(contractTotal);
  $bt('btBonusTotal').textContent = fmtUSD(bonusTotal);
  $bt('btAvgBonus').textContent = fmtUSD(avgBonus);

  const T=$bt('btTable'); T.innerHTML='';
  BT_VIEW.forEach(r=>{
    const row=document.createElement('div');
    row.style.display='grid';
    row.style.gridTemplateColumns='1.2fr 1fr 0.9fr 2fr 0.9fr 0.9fr';
    row.style.gap='10px';
    row.style.padding='10px';
    row.style.border='1px solid var(--border)';
    row.style.borderRadius='12px';
    row.style.background='#081b2b';
    row.innerHTML = `
      <div><b>${r.Name||'-'}</b></div>
      <div>${r.Owner||'-'}</div>
      <div>${r.Status||'-'}</div>
      <div>${r.Job||'-'}</div>
      <div>${fmtUSD(r.Contract||0)}</div>
      <div>${fmtUSD(r.Bonus||0)}</div>
    `;
    T.appendChild(row);
  });
}

function btNormalizeUrl(u){
  if(!u)return'';
  if(/tqx=out:csv/.test(u))return u;
  if(/\/pub\?/.test(u)&&/output=csv/.test(u))return u;
  const m=u.match(/spreadsheets\/d\/([^\/]+).*?[#\?].*?gid=(\d+)/);
  if(m)return 'https://docs.google.com/spreadsheets/d/'+m[1]+'/gviz/tq?tqx=out:csv&gid='+m[2];
  return u;
}
function btWithBust(url){ const s=url.includes('?')?'&':'?'; return url+s+'t='+(Date.now()); }
function btLoad(url){
  const norm = btNormalizeUrl(url.trim());
  if(!norm){ btChips(['Paste a valid CSV link']); return; }
  btChips(['Loading‚Ä¶']);
  fetch(btWithBust(norm))
    .then(r=>{ if(r.ok) return r.text(); throw new Error('HTTP '+r.status); })
    .then(text=>{
      const parsed = btParseCSV(text);
      if(!parsed.rows.length){ btChips(['Empty CSV or headers not recognized']); return; }
      BT_ALL = parsed.rows;
      btFillFilters(BT_ALL);
      $bt('btOwner').value='';
      $bt('btStatus').value='';
      $bt('btJobSearch').value='';
      btApply();
      btChips(['CSV loaded: '+BT_ALL.length+' rows']);
      setUpdated();
    })
    .catch(err=>{ btChips(['Failed to load CSV: '+err.message]); console.error(err); });
}

['btOwner','btStatus'].forEach(id=> $bt(id).addEventListener('change', btApply));
$bt('btJobSearch').addEventListener('input', btApply);
$bt('btClear').addEventListener('click', ()=>{
  $bt('btOwner').value=''; $bt('btStatus').value=''; $bt('btJobSearch').value='';
  btApply();
});
$bt('btReload').addEventListener('click', ()=> btLoad($bt('btCsvUrl').value));

/* Default CSVs */
const DEFAULT_LINK="https://docs.google.com/spreadsheets/d/e/2PACX-1vT7EMxEc6BGdAxnSphrzKpW03Bv6zz96bNiIz58PZCjwDHvW3XhKbXNuC0bZll9gg/pub?gid=1004742443&single=true&output=csv";
/* NEW: default for Bonus & Tech (current month) */
const BONUS_DEFAULT_LINK="https://docs.google.com/spreadsheets/d/e/2PACX-1vQOju0Fvn-Qe3oaTEZQiEm23CYOYtE6EChD6TNiW3y-MlUsHQcLPbrFPcgycz_x_Q_aEoO-XXlJpbnZ/pub?gid=2024260664&single=true&output=csv";

window.addEventListener('DOMContentLoaded',()=>{
  $('csvUrl').value = DEFAULT_LINK;
  $bt('btCsvUrl').value = BONUS_DEFAULT_LINK;   // ‚úÖ sempre preenche

  const v = new URLSearchParams(location.search).get('view');
  if(v==='atlus'){ loadFromUrl(DEFAULT_LINK); }
  if(v==='bonus'){ btLoad(BONUS_DEFAULT_LINK); }  // ‚úÖ auto-carrega o b√¥nus

  $('autoRefresh').dispatchEvent(new Event('change'));
  setUpdated();
});
  // Open/close login box
const loginBox   = document.getElementById('adminLoginBox');
const openBtn    = document.getElementById('openAdminLogin');
const cancelBtn  = document.getElementById('cancelAdminLogin');
const confirmBtn = document.getElementById('confirmAdminLogin');
const passInput  = document.getElementById('adminPassword');
const msgBox     = document.getElementById('adminLoginMsg');
const logoutBtn  = document.getElementById('logoutBtn');

if(openBtn){
  openBtn.addEventListener('click', ()=>{
    msgBox.textContent = "";
    passInput.value = "";
    loginBox.style.display = 'grid';
    passInput.focus();
  });
}
if(cancelBtn){
  cancelBtn.addEventListener('click', ()=> loginBox.style.display = 'none');
}
if(confirmBtn){
  confirmBtn.addEventListener('click', ()=>{
    const ok = passInput.value === ADMIN_PASS;
    if(ok){
      setAdmin(true);
      loginBox.style.display = 'none';
      // opcional: feedback
      msgBox.textContent = "";
    }else{
      msgBox.textContent = "Incorrect password.";
    }
  });
}
if(passInput){
  passInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){ confirmBtn.click(); }
  });
}
if(logoutBtn){
  logoutBtn.addEventListener('click', ()=>{
    setAdmin(false);
  });
}
</script>
</body>
</html>
